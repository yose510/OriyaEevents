<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×‘×§×¨×” - OriyaEvents</title>
    <link href="https://fonts.googleapis.com/css2?family=Yeseva+One&family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --rose: #ff6b9d;
            --deep-rose: #c9356b;
            --pearl: #fef4f8;
            --cream: #fff9f5;
            --charcoal: #2a2a2a;
            --gold: #d4af37;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Assistant', sans-serif;
            background: linear-gradient(165deg, var(--pearl) 0%, var(--cream) 40%, #fff 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            font-family: 'Yeseva One', serif;
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--rose), var(--deep-rose));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .user-info {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        .user-name {
            font-weight: 700;
            color: var(--charcoal);
        }
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Assistant', sans-serif;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--rose), var(--deep-rose));
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255,107,157,0.3);
        }
        .btn-ghost {
            background: var(--pearl);
            color: var(--deep-rose);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 40px;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--rose), var(--gold));
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }
        .stat-value {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--rose), var(--deep-rose));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Yeseva One', serif;
        }
        .stat-label {
            color: #666;
            margin-top: 8px;
            font-size: 1.1rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            border-bottom: 2px solid var(--pearl);
        }
        .tab {
            padding: 16px 32px;
            background: none;
            border: none;
            font-size: 1.15rem;
            font-weight: 700;
            color: #999;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        .tab.active {
            color: var(--rose);
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--rose);
        }

        /* Section */
        .section {
            background: white;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            display: none;
        }
        .section.active {
            display: block;
            animation: fadeIn 0.4s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section h2 {
            font-family: 'Yeseva One', serif;
            font-size: 2rem;
            margin-bottom: 32px;
            background: linear-gradient(135deg, var(--rose), var(--deep-rose));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Create Invitation Grid */
        .create-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .form-panel {
            background: var(--pearl);
            padding: 32px;
            border-radius: 20px;
        }
        .form-group {
            margin-bottom: 24px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--charcoal);
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Assistant', sans-serif;
            transition: all 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--rose);
            box-shadow: 0 0 0 4px rgba(255,107,157,0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Preview Panel */
        .preview-panel {
            position: sticky;
            top: 120px;
        }
        .preview-box {
            background: linear-gradient(165deg, #fff 0%, var(--pearl) 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 16px 48px rgba(255,107,157,0.15);
            min-height: 500px;
        }
        .preview-title {
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--deep-rose);
            font-size: 1.2rem;
        }

        /* Invitation Card */
        .invitation-card {
            background: white;
            border-radius: 20px;
            padding: 48px 40px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.4s;
        }
        .invitation-card.template-classic {
            background: linear-gradient(165deg, #fff9f5 0%, white 100%);
        }
        .invitation-card.template-modern {
            background: linear-gradient(135deg, #f5f5f5 0%, white 100%);
            border: 3px solid var(--rose);
        }
        .invitation-card.template-elegant {
            background: linear-gradient(165deg, var(--pearl) 0%, white 100%);
            border-top: 5px solid var(--gold);
        }
        .invitation-card.template-floral {
            background: white;
            box-shadow: inset 0 0 0 2px var(--rose);
        }
        .card-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.05;
            pointer-events: none;
        }
        .card-content {
            position: relative;
            z-index: 1;
        }
        .card-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }
        .card-title {
            font-size: 1.3rem;
            color: var(--deep-rose);
            margin-bottom: 24px;
            font-weight: 600;
        }
        .card-names {
            font-family: 'Yeseva One', serif;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--rose), var(--deep-rose));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 24px 0;
            line-height: 1.3;
        }
        .card-details {
            margin-top: 32px;
            line-height: 2;
            color: var(--charcoal);
        }
        .card-details p {
            margin: 8px 0;
        }

        /* Template Gallery */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .template-option {
            background: white;
            border: 3px solid var(--pearl);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .template-option:hover {
            transform: translateY(-4px);
            border-color: var(--rose);
        }
        .template-option.selected {
            border-color: var(--rose);
            background: var(--pearl);
        }
        .template-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        /* Color Picker */
        .color-picker {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: var(--charcoal);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--charcoal);
        }

        /* Excel Upload */
        .upload-zone {
            border: 3px dashed var(--rose);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--pearl);
        }
        .upload-zone:hover {
            background: white;
            border-color: var(--deep-rose);
        }
        .upload-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        /* Guests Table */
        .guests-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }
        .guests-table thead {
            background: linear-gradient(135deg, var(--rose), var(--deep-rose));
            color: white;
        }
        .guests-table th {
            padding: 16px;
            text-align: right;
            font-weight: 700;
        }
        .guests-table td {
            padding: 16px;
            border-bottom: 1px solid var(--pearl);
        }
        .guests-table tbody tr:hover {
            background: var(--pearl);
        }
        .status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        .status-valid {
            background: #d4edda;
            color: #155724;
        }
        .status-invalid {
            background: #f8d7da;
            color: #721c24;
        }

        /* AI Section */
        .ai-panel {
            background: linear-gradient(135deg, var(--pearl) 0%, white 100%);
            padding: 32px;
            border-radius: 20px;
            border: 2px solid var(--rose);
        }
        .ai-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }
        .ai-icon {
            font-size: 3rem;
        }
        .ai-title {
            font-family: 'Yeseva One', serif;
            font-size: 1.6rem;
            background: linear-gradient(135deg, var(--rose), var(--deep-rose));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @media (max-width: 968px) {
            .create-grid {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">OriyaEvents</div>
        <div class="user-info">
            <span class="user-name" id="userName">×˜×•×¢×Ÿ...</span>
            <button class="btn btn-ghost" onclick="logout()">×™×¦×™××”</button>
        </div>
    </div>

    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¦</div>
                <div class="stat-value" id="available">0</div>
                <div class="stat-label">×”×–×× ×•×ª ×–××™× ×•×ª</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¤</div>
                <div class="stat-value" id="sent">0</div>
                <div class="stat-label">×”×–×× ×•×ª ×©× ×©×œ×—×•</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-value" id="cost">â‚ª0</div>
                <div class="stat-label">×¢×œ×•×ª × ×•×¡×¤×ª</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('create')">×™×¦×™×¨×ª ×”×–×× ×” âœ¨</button>
            <button class="tab" onclick="switchTab('send')">×©×œ×™×—×ª ×”×–×× ×•×ª ğŸ’¬</button>
            <button class="tab" onclick="switchTab('history')">×”×™×¡×˜×•×¨×™×” ğŸ“œ</button>
            <button class="tab" onclick="switchTab('package')">×”×—×‘×™×œ×” ×©×œ×™ ğŸ“¦</button>
        </div>

        <!-- Create Section -->
        <div class="section active" id="createSection">
            <h2>×¦×•×¨ ×”×–×× ×” ××¨×”×™×‘×”</h2>
            
            <div class="create-grid">
                <div class="form-panel">
                    <form id="inviteForm" onsubmit="return createInvite(event)">
                        <div class="form-group">
                            <label>×¡×•×’ ××™×¨×•×¢</label>
                            <select id="eventType" onchange="updatePreview()">
                                <option value="wedding">×—×ª×•× ×” ğŸ’</option>
                                <option value="bar_mitzvah">×‘×¨ ××¦×•×•×” ğŸ‰</option>
                                <option value="bat_mitzvah">×‘×ª ××¦×•×•×” ğŸ€</option>
                            </select>
                        </div>

                        <div id="weddingFields">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>×©× ×”×—×ª×Ÿ</label>
                                    <input type="text" id="groomName" onchange="updatePreview()">
                                </div>
                                <div class="form-group">
                                    <label>×©× ×”×›×œ×”</label>
                                    <input type="text" id="brideName" onchange="updatePreview()">
                                </div>
                            </div>
                        </div>

                        <div id="barBatFields" style="display:none;">
                            <div class="form-group">
                                <label>×©× ×‘×¨/×‘×ª ×”××¦×•×•×”</label>
                                <input type="text" id="barBatName" onchange="updatePreview()">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>×ª××¨×™×š</label>
                                <input type="date" id="eventDate" required onchange="updatePreview()">
                            </div>
                            <div class="form-group">
                                <label>×©×¢×”</label>
                                <input type="time" id="eventTime" required onchange="updatePreview()">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>××•×œ×</label>
                            <input type="text" id="venue" required onchange="updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>×›×ª×•×‘×ª</label>
                            <input type="text" id="address" required onchange="updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>××™×“×¢ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)</label>
                            <textarea id="additionalInfo" rows="3" onchange="updatePreview()"></textarea>
                        </div>

                        <div class="form-group">
                            <label>×ª×‘× ×™×ª ×¢×™×¦×•×‘×™×ª</label>
                            <div class="template-grid">
                                <div class="template-option selected" onclick="selectTemplate('classic')">
                                    <div class="template-icon">ğŸŒ¸</div>
                                    <div>×§×œ××¡×™</div>
                                </div>
                                <div class="template-option" onclick="selectTemplate('modern')">
                                    <div class="template-icon">âœ¨</div>
                                    <div>××•×“×¨× ×™</div>
                                </div>
                                <div class="template-option" onclick="selectTemplate('elegant')">
                                    <div class="template-icon">ğŸ‘‘</div>
                                    <div>××œ×’× ×˜×™</div>
                                </div>
                                <div class="template-option" onclick="selectTemplate('floral')">
                                    <div class="template-icon">ğŸŒº</div>
                                    <div>×¤×¨×—×•× ×™</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>×¦×‘×¢ ×¨×§×¢</label>
                            <div class="color-picker">
                                <div class="color-option selected" style="background:#ffe4f0" onclick="selectColor('#ffe4f0', this)"></div>
                                <div class="color-option" style="background:#e4f0ff" onclick="selectColor('#e4f0ff', this)"></div>
                                <div class="color-option" style="background:#fff9e4" onclick="selectColor('#fff9e4', this)"></div>
                                <div class="color-option" style="background:#f0ffe4" onclick="selectColor('#f0ffe4', this)"></div>
                                <div class="color-option" style="background:#ffe4ff" onclick="selectColor('#ffe4ff', this)"></div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width:100%; font-size:1.2rem;">ğŸ’¾ ×©××•×¨ ×”×–×× ×”</button>
                    </form>
                </div>

                <div class="preview-panel">
                    <div class="preview-title">×ª×¦×•×’×” ××§×“×™××”</div>
                    <div class="preview-box">
                        <div class="invitation-card template-classic" id="previewCard">
                            <div class="card-bg" id="cardBg"></div>
                            <div class="card-content">
                                <div class="card-icon" id="cardIcon">ğŸ’</div>
                                <div class="card-title" id="cardTitle">××•×–×× ×™× ×œ×—×ª×•× ×”</div>
                                <div class="card-names" id="cardNames">×©× ×”×—×ª×Ÿ ×•×©× ×”×›×œ×”</div>
                                <div class="card-details">
                                    <p id="previewDate">ğŸ“… ×ª××¨×™×š</p>
                                    <p id="previewTime">ğŸ• ×©×¢×”</p>
                                    <p id="previewVenue">ğŸ›ï¸ ××•×œ×</p>
                                    <p id="previewAddress">ğŸ“ ×›×ª×•×‘×ª</p>
                                    <p id="previewInfo"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Send Section -->
        <div class="section" id="sendSection">
            <h2>×©×œ×™×—×ª ×”×–×× ×•×ª ×‘-WhatsApp</h2>
            
            <div class="ai-panel" style="margin-bottom:32px;">
                <div class="ai-header">
                    <div class="ai-icon">ğŸ¤–</div>
                    <div class="ai-title">×™×¦×™×¨×” ×¢× AI</div>
                </div>
                <p style="margin-bottom:20px;">×ª××¨ ××ª ×”××™×¨×•×¢ ×•× ×•×¦×¨ ×¢×‘×•×¨×š ×”×–×× ×” ××•×©×œ××ª ×¢× ×‘×™× ×” ××œ××›×•×ª×™×ª!</p>
                <textarea id="aiPrompt" rows="3" style="width:100%; padding:12px; border-radius:12px; border:2px solid var(--pearl);" placeholder='×œ×“×•×’××”: "×—×ª×•× ×” ×¨×•×× ×˜×™×ª ×‘×’×Ÿ ××™×¨×•×¢×™× ×‘×©×¢×ª ×”×©×§×™×¢×”..."'></textarea>
                <button class="btn btn-primary" onclick="generateWithAI()" style="margin-top:16px;">âœ¨ ×¦×•×¨ ×¢× AI</button>
            </div>

            <div class="upload-zone" id="uploadZone">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleExcel(event)">
                <div class="upload-icon">ğŸ“Š</div>
                <h3>×”×¢×œ×” ×§×•×‘×¥ Excel</h3>
                <p>×’×¨×•×¨ ×§×•×‘×¥ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</p>
                <button class="btn btn-primary" onclick="document.getElementById('excelFile').click()" style="margin-top:20px;">×‘×—×¨ ×§×•×‘×¥</button>
            </div>

            <div id="guestsSection" style="display:none; margin-top:32px;">
                <h3 style="margin-bottom:20px;">×¨×©×™××ª ××•×¨×—×™× (<span id="guestCount">0</span>)</h3>
                <table class="guests-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleAll(this)"></th>
                            <th>×©×</th>
                            <th>×˜×œ×¤×•×Ÿ</th>
                            <th>×¡×˜×˜×•×¡</th>
                        </tr>
                    </thead>
                    <tbody id="guestsTable"></tbody>
                </table>
                <button class="btn btn-primary" onclick="sendWhatsApp()" style="margin-top:24px; font-size:1.2rem;">ğŸ’¬ ×©×œ×— ×‘-WhatsApp</button>
            </div>
        </div>

        <!-- History Section -->
        <div class="section" id="historySection">
            <h2>×”×™×¡×˜×•×¨×™×™×ª ×©×œ×™×—×•×ª</h2>
            <div id="historyList">×˜×•×¢×Ÿ...</div>
        </div>

        <!-- Package Section -->
        <div class="section" id="packageSection">
            <h2>×”×—×‘×™×œ×” ×©×œ×™</h2>
            <div style="background:var(--pearl); padding:32px; border-radius:20px;">
                <h3 style="margin-bottom:20px;">×¤×¨×˜×™ ×—×‘×™×œ×”</h3>
                <p style="font-size:1.2rem; margin:12px 0;"><strong>×”×–×× ×•×ª ×–××™× ×•×ª:</strong> <span id="pkgAvail">0</span></p>
                <p style="font-size:1.2rem; margin:12px 0;"><strong>×”×–×× ×•×ª ×©× ×©×œ×—×•:</strong> <span id="pkgSent">0</span></p>
                <p style="font-size:1.2rem; margin:12px 0;"><strong>×¢×œ×•×ª × ×•×¡×¤×ª:</strong> <span id="pkgCost">â‚ª0</span></p>
                <button class="btn btn-primary" style="margin-top:24px;">ğŸ’³ ×¨×›×•×© ×—×‘×™×œ×” × ×•×¡×¤×ª</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const sb = window.supabase.createClient(
            'https://kzxyewemuykimsblotif.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eHlld2VtdXlraW1zYmxvdGlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTkyOTMsImV4cCI6MjA4NjEzNTI5M30.WzXKlxgNtziO6OBgXEQjhdNiR8eEJqOZFDFwjfFNoHY'
        );

        let currentUser = null;
        let currentTemplate = 'classic';
        let currentColor = '#ffe4f0';
        let guestsList = [];

        async function init() {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) { window.location.href = 'index.html'; return; }
            
            const { data: profile } = await sb.from('users').select('*').eq('id', user.id).single();
            if (profile.is_admin) { window.location.href = 'admin.html'; return; }
            
            currentUser = profile;
            document.getElementById('userName').textContent = profile.full_name;
            
            const available = profile.package_invites - profile.package_sent;
            const extra = Math.max(0, profile.package_sent - profile.package_invites);
            
            document.getElementById('available').textContent = available;
            document.getElementById('sent').textContent = profile.package_sent;
            document.getElementById('cost').textContent = `â‚ª${extra}`;
            
            document.getElementById('pkgAvail').textContent = available;
            document.getElementById('pkgSent').textContent = profile.package_sent;
            document.getElementById('pkgCost').textContent = `â‚ª${extra}`;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
        }

        function updatePreview() {
            const type = document.getElementById('eventType').value;
            const groom = document.getElementById('groomName').value || '×©× ×”×—×ª×Ÿ';
            const bride = document.getElementById('brideName').value || '×©× ×”×›×œ×”';
            const barBat = document.getElementById('barBatName').value || '×©× ×‘×¨/×‘×ª ×”××¦×•×•×”';
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const venue = document.getElementById('venue').value || '××•×œ×';
            const address = document.getElementById('address').value || '×›×ª×•×‘×ª';
            const info = document.getElementById('additionalInfo').value;

            // Toggle fields
            if (type === 'wedding') {
                document.getElementById('weddingFields').style.display = 'block';
                document.getElementById('barBatFields').style.display = 'none';
                document.getElementById('cardIcon').textContent = 'ğŸ’';
                document.getElementById('cardTitle').textContent = '××•×–×× ×™× ×œ×—×ª×•× ×”';
                document.getElementById('cardNames').textContent = `${groom} ×•${bride}`;
            } else {
                document.getElementById('weddingFields').style.display = 'none';
                document.getElementById('barBatFields').style.display = 'block';
                document.getElementById('cardIcon').textContent = type === 'bar_mitzvah' ? 'ğŸ‰' : 'ğŸ€';
                document.getElementById('cardTitle').textContent = type === 'bar_mitzvah' ? '××•×–×× ×™× ×œ×‘×¨ ××¦×•×•×”' : '××•×–×× ×™× ×œ×‘×ª ××¦×•×•×”';
                document.getElementById('cardNames').textContent = barBat;
            }

            if (date) {
                const d = new Date(date);
                document.getElementById('previewDate').textContent = `ğŸ“… ${d.toLocaleDateString('he-IL')}`;
            }
            document.getElementById('previewTime').textContent = `ğŸ• ${time || '×©×¢×”'}`;
            document.getElementById('previewVenue').textContent = `ğŸ›ï¸ ${venue}`;
            document.getElementById('previewAddress').textContent = `ğŸ“ ${address}`;
            document.getElementById('previewInfo').textContent = info;
        }

        function selectTemplate(template) {
            currentTemplate = template;
            document.querySelectorAll('.template-option').forEach(t => t.classList.remove('selected'));
            event.target.closest('.template-option').classList.add('selected');
            
            const card = document.getElementById('previewCard');
            card.className = `invitation-card template-${template}`;
        }

        function selectColor(color, el) {
            currentColor = color;
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('cardBg').style.background = color;
        }

        async function createInvite(e) {
            e.preventDefault();
            
            const type = document.getElementById('eventType').value;
            const data = {
                user_id: currentUser.id,
                event_type: type,
                title: document.getElementById('cardTitle').textContent,
                groom_name: type === 'wedding' ? document.getElementById('groomName').value : null,
                bride_name: type === 'wedding' ? document.getElementById('brideName').value : null,
                bar_bat_name: type !== 'wedding' ? document.getElementById('barBatName').value : null,
                event_date: document.getElementById('eventDate').value,
                event_time: document.getElementById('eventTime').value,
                venue: document.getElementById('venue').value,
                address: document.getElementById('address').value,
                additional_info: document.getElementById('additionalInfo').value,
                template: currentTemplate,
                background_color: currentColor
            };
            
            const { error } = await sb.from('invitations').insert([data]);
            
            if (error) {
                alert('×©×’×™××”: ' + error.message);
            } else {
                alert('âœ… ×”×”×–×× ×” × ×©××¨×” ×‘×”×¦×œ×—×”!');
                e.target.reset();
                updatePreview();
            }
            
            return false;
        }

        function handleExcel(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws);
                
                guestsList = json.map((row, i) => ({
                    id: i,
                    name: row['×©×'] || row['name'] || '',
                    phone: String(row['×˜×œ×¤×•×Ÿ'] || row['phone'] || '').replace(/\s/g, ''),
                    valid: /^972\d{9}$/.test(String(row['×˜×œ×¤×•×Ÿ'] || row['phone'] || '').replace(/\s/g, '')),
                    selected: true
                }));
                
                displayGuests();
            };
            reader.readAsArrayBuffer(file);
        }

        function displayGuests() {
            document.getElementById('guestsSection').style.display = 'block';
            document.getElementById('guestCount').textContent = guestsList.length;
            
            document.getElementById('guestsTable').innerHTML = guestsList.map(g => `
                <tr>
                    <td><input type="checkbox" ${g.selected ? 'checked' : ''} ${!g.valid ? 'disabled' : ''} onchange="toggleGuest(${g.id}, this.checked)"></td>
                    <td>${g.name}</td>
                    <td>${g.phone}</td>
                    <td><span class="status-badge ${g.valid ? 'status-valid' : 'status-invalid'}">${g.valid ? 'âœ“ ×ª×§×™×Ÿ' : 'âœ— ×œ× ×ª×§×™×Ÿ'}</span></td>
                </tr>
            `).join('');
        }

        function toggleGuest(id, checked) {
            const guest = guestsList.find(g => g.id === id);
            if (guest) guest.selected = checked;
        }

        function toggleAll(el) {
            guestsList.forEach(g => {
                if (g.valid) g.selected = el.checked;
            });
            displayGuests();
        }

        async function sendWhatsApp() {
            const selected = guestsList.filter(g => g.selected);
            if (selected.length === 0) {
                alert('× × ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××•×¨×— ××—×“');
                return;
            }
            
            if (!confirm(`×œ×©×œ×•×— ×œ-${selected.length} ××•×¨×—×™×?`)) return;
            
            // Here you would integrate with WhatsApp API or use click-to-chat
            alert(`× ×©×œ×—×• ${selected.length} ×”×–×× ×•×ª! (×¤×™×¦'×¨ ×‘×¤×™×ª×•×—)`);
        }

        async function generateWithAI() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) {
                alert('× × ×œ×”×–×™×Ÿ ×ª×™××•×¨ ×œ××™×¨×•×¢');
                return;
            }
            
            alert('ğŸ¤– ×™×¦×™×¨×” ×¢× AI - ×¤×™×¦'×¨ ×‘×¤×™×ª×•×—!\n\n×‘×’×¨×¡×” ×”×‘××” × ×©×œ×‘ ××ª Grok AI ×œ×™×¦×™×¨×ª ×”×–×× ×•×ª ××•×˜×•××˜×™×ª.');
        }

        async function logout() {
            await sb.auth.signOut();
            window.location.href = 'index.html';
        }

        document.getElementById('eventType').addEventListener('change', updatePreview);
        init();
    </script>
</body>
</html>
